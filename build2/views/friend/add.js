define("webapp/views/friend/add.js",["common/funs","webapp/common/baseview","text!webapp/templates/friend/add.html","webapp/common/app","common/url","base/date","webapp/stores/stores","webapp/models/models"],function(require){var e=require("common/funs"),t=require("webapp/common/baseview"),i=require("text!webapp/templates/friend/add.html"),n=require("webapp/common/app"),s=(require("common/url"),require("base/date"),require("webapp/stores/stores")),a=require("webapp/models/models"),o=(s.UserStore.getInstance(),e.createLazyValue(function(){return a.FriendListModel.getInstance()}),e.createLazyValue(function(){return a.UserQRModel.getInstance()})),d=e.createLazyValue(function(){return a.UserInviteModel.getInstance()}),r="http://www.wandoujia.com/apps/com.sds.android.ttpod",c=function(e){var t=e.replace(r+"#",""),i=t.split(","),n={};return _.each(i,function(e){var t=e.split(":");n[t[0]]=t[1]||0}),n};return t.extend({onCreate:function(){this.el.html(i)},events:{"click .topage":"toPage","click .addfriends":"scanQR"},toPage:function(){this.forward("createqr")},onLoad:function(e){var t="";"index"==e&&(t="notanimte"),this.isHeaderHidden()&&this.showHeader(),this.turning(t),this.setHeader({title:"我的二维码",leftHandle:function(){this.back("home")},rightTitle:'<span class="scan-icon"></span>',rightHandle:function(){this.scanQR()}}),this.getUser(function(e){this.createQR(e),this.checkAddFriendsMessage(e)}),this.setBackground("url(./src/style/qr-bg.png) repeat center center","100% auto")},scanQR:function(){this.showLoading(),o().endLoopRequest(),setTimeout(function(){n.scanQR({callback:function(e){this.hideLoading(),e?this.addFriend(e):this.checkAddFriendsMessage()},error:function(){this.hideLoading(),this.checkAddFriendsMessage()},cancel:function(){this.hideLoading(),this.checkAddFriendsMessage()},space:this})}.bind(this),500)},createQR:function(e){var t={};t.source=r+"#to_uid:"+e._id+",qr_id:"+(e.qrCode&&e.qrCode._id),n.createQR(t,{callback:function(e){this.$(".qrbox").html('<img src="data:image/png;base64,'+e.png+'"/>')},error:function(e){},cancel:function(){},space:this})},checkAddFriendsMessage:function(e){function t(e){var t=o();t.setParam("qrid",e.qrCode&&e.qrCode._id),t.loopRequest(3,{success:function(e){e=e||{},e._id&&this.forward(e.register?"friend/confirm?uid="+e._id:"friend/edit?uid="+e._id)}},this)}e?t.call(this,e):this.getUid(t)},addFriend:function(e){e=decodeURIComponent(e),this.showLoading(),this.getUid(function(t){if(e.indexOf("to_uid")>-1&&e.indexOf("qr_id")>-1){var i=c(e),n=d();n.setParam("uid",t._id),n.setParam("to_uid",i.to_uid),n.setParam("qr_id",i.qr_id),n.request({success:function(e,t){200===t?this.forward(e.data.register?"friend/confirm?uid="+e.data._id:"friend/edit?uid="+e.data._id):304===t?this.showToast("对方已经是你的好友！",2):this.showToast("添加好友失败！",2)},error:function(e,t){306===t?this.showToast("好友数量已满，无法添加好友",2):307===t?this.showToast("对方好友数量已满，无法添加好友",2):this.showToast("添加好友失败！",2),this.checkAddFriendsMessage()},complete:function(){this.hideLoading()}},this)}else this.showToast("二维码不正确！",3),this.checkAddFriendsMessage(),this.hideLoading()})},onShow:function(){},onHide:function(){var e=o();e.endLoopRequest()}})});