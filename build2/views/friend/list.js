define("webapp/views/friend/list.js",["common/funs","webapp/common/baseview","text!webapp/templates/friend/list.html","webapp/common/app","common/url","base/date","webapp/stores/stores","webapp/models/models"],function(require){var e=require("common/funs"),t=require("webapp/common/baseview"),i=require("text!webapp/templates/friend/list.html"),s=require("webapp/common/app"),n=(require("common/url"),require("base/date")),d=require("webapp/stores/stores"),a=require("webapp/models/models"),r=(d.UserStore.getInstance(),e.createLazyValue(function(){return a.FriendListModel.getInstance()})),o=e.createLazyValue(function(){return a.UserQRModel.getInstance()}),c=e.createLazyValue(function(){return a.UserInviteModel.getInstance()}),h="http://www.wandoujia.com/apps/com.sds.android.ttpod",u=function(e){var t=e.replace(h+"#",""),i=t.split(","),s={};return _.each(i,function(e){var t=e.split(":");s[t[0]]=t[1]||0}),s};return t.extend({onCreate:function(){this.el.html(i),this.tpl_friendlist=_.template(this.$("#tpl-friendlist").html()),this.el_friendlist=this.$(".friend-list")},events:{"click .topage":"toPage","click .js-friend-item":"friendItemOnClick","click .addfriends":"scanQR","click .js_edit_friend":"editFriend"},editFriend:function(e){var t=$(e.currentTarget),i=t.closest(".js-friend-item").attr("data-uid");this.forward("friend/edit?uid="+i+"&from=list")},friendItemOnClick:function(e){var t=$(e.currentTarget);if(!$(e.target).hasClass("js_edit_friend")){var i=t.attr("data-uid");this.getUid(function(e){this.forward("share/master?masterid="+e._id+"&friendid="+i)})}},toPage:function(){this.forward("createqr")},onLoad:function(e){var t="";"index"==e&&(t="notanimte"),this.isHeaderHidden()&&this.showHeader(),this.turning(t),this.setHeader({title:"我的好友",leftHandle:function(){this.back("listener/home")},rightTitle:'<span class="scan-icon"></span>',rightHandle:function(){this.scanQR()}}),this.getUser(function(e){this.createQR(e),this.checkAddFriendsMessage(e),this.getFriendList(e)})},scanQR:function(){this.showLoading(),o().endLoopRequest(),setTimeout(function(){s.scanQR({callback:function(e){this.hideLoading(),e?this.addFriend(e):this.checkAddFriendsMessage()},error:function(){this.hideLoading(),this.checkAddFriendsMessage()},cancel:function(){this.hideLoading(),this.checkAddFriendsMessage()},space:this})}.bind(this),500)},createQR:function(e){var t={};t.source=h+"#to_uid:"+e._id+",qr_id:"+(e.qrCode&&e.qrCode._id),s.createQR(t,{callback:function(e){this.$(".qrbox").html('<img src="data:image/png;base64,'+e.png+'"/>')},error:function(e){},cancel:function(){},space:this})},getFriendList:function(e,t){this.showLoading();var i=r();i.setParam("uid",e._id),i.request({success:function(e){this.renderFriendList(e),t&&t.call(this)},error:function(){this.showToast("小天有点忙，退出再重新进入~",3)},complete:function(){this.hideLoading()}},this)},renderFriendList:function(e){this.el_friendlist.html(this.tpl_friendlist({list:e.data,DDate:n}))},checkAddFriendsMessage:function(e){function t(e){var t=o();t.setParam("qrid",e.qrCode&&e.qrCode._id),t.loopRequest(3,{success:function(e){e=e||{},e._id&&this.forward(e.register?"friend/confirm?uid="+e._id:"friend/edit?uid="+e._id)}},this)}e?t.call(this,e):this.getUid(t)},addFriend:function(e){e=decodeURIComponent(e),this.showLoading(),this.getUid(function(t){if(e.indexOf("to_uid")>-1&&e.indexOf("qr_id")>-1){var i=u(e),s=c();s.setParam("uid",t._id),s.setParam("to_uid",i.to_uid),s.setParam("qr_id",i.qr_id),s.request({success:function(e,t){200===t?this.forward(e.data.register?"friend/confirm?uid="+e.data._id:"friend/edit?uid="+e.data._id):304===t?this.showToast("对方已经是你的好友！",2):this.showToast("添加好友失败！",2)},error:function(e,t){306===t?this.showToast("好友数量已满，无法添加好友",2):307===t?this.showToast("对方好友数量已满，无法添加好友",2):this.showToast("添加好友失败！",2),this.checkAddFriendsMessage()},complete:function(){this.hideLoading()}},this)}else this.showToast("二维码不正确！",3),this.checkAddFriendsMessage(),this.hideLoading()})},onShow:function(){},onHide:function(){var e=o();e.endLoopRequest()}})});