define("webapp/views/home.js",["webapp/common/baseview","common/lrcview","webapp/common/app","webapp/common/oldapp","text!webapp/templates/home.html","webapp/common/userslide","webapp/models/models","webapp/business/guidelayer","base/log","ui/dialog"],function(require){var t=require("webapp/common/baseview"),e=(require("common/lrcview"),require("webapp/common/app")),i=require("webapp/common/oldapp"),a=require("text!webapp/templates/home.html"),s=(require("webapp/common/userslide"),require("webapp/models/models")),n=require("webapp/business/guidelayer"),o=(require("base/log"),require("ui/dialog")),r=s.FriendListModel.createLazyFun(),d=s.MyFollowMasterModel.createLazyFun(),h=s.ListenerOfMyModel.createLazyFun(),l=s.ExitRoomModel.createLazyFun(),c=s.SharePostModel.createLazyFun(),f=function(){},u="http://"+location.host+"/follow/t.html?",m="http://"+location.host+"/follow/#";return t.extend({onCreate:function(){this.el.html(a),this.el_fribox=this.$(".js_fribox"),this.tpl_friitem=this.$T("#tpl_friitem")},events:{"click .js_fribox i.target":"showPopMenu","click .fri-add":function(){this.forward("friend/add")},"click .js_eyebtn":"toMasterHome","click .js_headsetbtn":"toListenerPlay","click .js_share":"toShare"},_alert:null,_editHandle:f,_historyHandle:f,showPopMenu:function(t){var e=$(t.currentTarget),i=this,a=e.closest("li").attr("data-uid");if(this._editHandle=function(){this.forward("friend/edit?uid="+a+"&from=list")},this._historyHandle=function(){this.getUid(function(t){this.forward("share/master?masterid="+t._id+"&friendid="+a)})},!this._alert){this._alert=new o({hideTitle:!0,content:"请操作",cls:"fri-edit-menu",buttons:[{title:"编辑资料",click:function(){this.hide(),i._editHandle()}},{title:"查看历史",click:function(){this.hide(),i._historyHandle()}},{title:"取消",click:function(){this.hide()}}]});var s=this._alert;this._alert.on("create",function(){this.mask.on("create",function(){this.$el.on("click",function(){s.hide()})})})}this._alert.show()},toShare:function(){var t="share/play?masterid="+this.uid+"&t="+(+new Date+String(Math.random()).replace(".",""));i.send("share",{url:u+t,desc:"此刻，与我同听一首歌",title:"此刻，与我同听一首歌"});var e=c();e.setParam("masterId",this.uid),e.setParam("link",m+t),e.request()},toMasterHome:function(){this.forward("master/home")},toListenerPlay:function(t){var i=$(t.target).closest("li").attr("data-uid"),a=this;this.showLoading(),this.getUid(function(t){e.pause(),setTimeout(function(){var s=l();s.setParam("masterid",t._id),s.request({success:function(t,s){200==s||204==s?setTimeout(function(){e.closeAppSendMessage(),setTimeout(function(){a.forward("listener/play?masterid="+i),a.hideLoading()},100)},100):(this.showToast("小天有点忙，退出再重新进入~",2),this.hideLoading())},error:function(t,e){this.showToast("小天有点忙，退出再重新进入~",2),this.hideLoading()}},this)}.bind(this),50)})},editFriend:function(t){var e=$(t.currentTarget),i=e.closest("li").attr("data-uid");this.forward("friend/edit?uid="+i+"&from=list")},onLoad:function(t){this.setHeader({title:"跟TA一起听",leftHandle:function(){e.backApp()},rightTitle:'<span class="icon-add"></span>加好友',rightHandle:function(){this.forward("friend/add")}}),this.isHeaderHidden()&&this.showHeader();var i="";"index"==t&&(i="notanimte"),this.turning(i),this.showLoading(),this.getUser(function(t){this.loadFriendList(t),this.uid=t._id})},showGuideLayer:function(){var t=this;if("index"===this.$Q("from")){var e=new n({topRightHandle:function(){this.hide(),t.forward("friend/add")}});e.show()}},loadFriendList:function(t){var e=r();e.setParam("uid",t._id),e.request({success:function(e){this._renderFriendList(e.data||[]),this.loopListenersList(t),this.loopMasterList(t),e&&e.data&&e.data.length||this.showGuideLayer()},error:function(){this.showToast("小天有点忙，退出再重新进入~",3)},complete:function(){this.hideLoading()}},this)},_renderFriendList:function(t){this.el_fribox.html(this.tpl_friitem({list:t}))},loopListenersList:function(t){var e=h();e.setParam("uid",t._id),e.loopRequest(5,{success:function(t){this._updateFriendStateOfListener(t.data||[])}},this)},_updateFriendStateOfListener:function(t){var e=this,i={};_.each(t,function(t){i[t.listenerId]=!0;var a=e.el_fribox.find('li[data-uid="'+t.listenerId+'"]');a.find(".fri-state").html("正在听你的歌"),a.find(".fri-btn").hide().filter(".js_eyebtn").show(),a.attr("data-listener","1")});var a=e.el_fribox.find('li[data-listener="1"]');a.each(function(){var t=$(this);i[t.attr("data-uid")]||(t.find(".fri-state").html(""),t.find(".fri-btn").hide(),t.removeAttr("data-listener"))})},loopMasterList:function(t){var e=d();e.setParam("listenerId",t._id),e.loopRequest(2,{success:function(t){this._updateFriendStateOfMaster(t.data||[])}},this)},_updateFriendStateOfMaster:function(t){var e=this,i={};_.each(t,function(t){var a=t.action;if(0===a||1===a||3===a||5===a){i[t.masterId]=!0;var s=e.el_fribox.find('li[data-uid="'+t.masterId+'"]');s.find(".fri-state").html("正在听歌"),s.find(".fri-btn").hide().filter(".js_headsetbtn").show(),s.attr("data-master","1")}});var a=e.el_fribox.find('li[data-master="1"]');a.each(function(){var t=$(this);i[t.attr("data-uid")]||(t.find(".fri-state").html(""),t.find(".fri-btn").hide(),t.removeAttr("data-master"))})},onShow:function(){},onHide:function(){d().endLoopRequest(),h().endLoopRequest()}})});