define("webapp/views/listener/home.js",["base/base","webapp/common/baseview","base/date","webapp/common/app","text!webapp/templates/listener/home.html","webapp/models/models"],function(require){function t(t){var i=[];return e.each(t,function(t){i.push(t.masterId+","+t.action+","+t.songId+","+t.position)}),i}var e=require("base/base"),i=require("webapp/common/baseview"),s=require("base/date"),n=require("webapp/common/app"),r=require("text!webapp/templates/listener/home.html"),o=require("webapp/models/models"),a=o.MyFollowMasterModel.createLazyFun(),h=o.ListenerOfMyModel.createLazyFun(),d=o.MyListenerRecordModel.createLazyFun(),l=o.ExitRoomModel.createLazyFun();return i.extend({onCreate:function(){this.el.html(r),this.el_friendlist=this.$(".l-g-friend-list"),this.el_history=this.$(".l-g-history"),this.tpl_friend_list=_.template(this.$("#tpl_friend_list").html()),this.tpl_history=_.template(this.$("#tpl_history").html()),this.currentListenerSize=0},events:{"click .topage":"toPage","click .js_master_list li[data-masterid]":"toListenMaster"},toPage:function(){this.forward("friend/list")},toListenMaster:function(t){var e=$(t.currentTarget),i=this,s=e.attr("data-masterid");this.showLoading(),this.getUid(function(t){n.pause(),setTimeout(function(){var e=l();e.setParam("masterid",t._id),e.request({success:function(t,e){200==e||204==e?setTimeout(function(){n.closeAppSendMessage(),setTimeout(function(){i.forward("listener/play?masterid="+s),i.hideLoading()},100)},100):(this.showToast("小天有点忙，退出再重新进入~",2),this.hideLoading())},error:function(t,e){this.showToast("小天有点忙，退出再重新进入~",2),this.hideLoading()}},this)}.bind(this),50)})},switchheader:function(){},switchheader2:function(){},_lastView:"",onLoad:function(t){this._lastView=t,this.firstError=!1,this.setHeader({title:"跟TA一起听",leftHandle:function(){n.backApp()},rightTitle:"我的好友",rightHandle:function(){this.forward("friend/list")}}),this.getUid(function(t){this.loadMasterList(t._id),this.loadMyListenerRecord(t._id),this.loopListenersList(t._id)}),this.isHeaderHidden()&&this.showHeader();var e="";"index"==t&&(e="notanimte"),this.turning(e)},idlist:"none",loadMasterList:function(e){var i=a();this.showLoading(),i.setParam("listenerId",e),i.loopRequest(2,{success:function(e){var i=t(e.data),s=i.join(",");this.idlist!=s&&this.renderMasterList(e.data),this.idlist=s},error:function(){this.firstError||(this.firstError=!0)},complete:function(){this.hideLoading()}},this)},loopListenersList:function(t){var e=h(),i=this;e.setParam("uid",t),e.loopRequest(5,{success:function(t){var e=t.data||[],s=e&&e.length||0;this.currentListenerSize<s&&"master/home"!==this._lastView&&(this._lastView="",this.showAlert("有人在听你的歌，去看看吧～",[{title:"知道了",click:function(){i.forward("master/home"),this.hide()}}],"好友来听歌了")),this.currentListenerSize=s}},this)},renderMasterList:function(t){t=_.filter(t,function(t){var e=t.action;return 0===e||1===e||3===e||5===e}),this.el_friendlist.html(this.tpl_friend_list({list:t}))},loadMyListenerRecord:function(t){var e=d();e.setParam("masterId",t),e.request({success:function(t){this.renderMyListenerRecord(t.data)}},this)},renderMyListenerRecord:function(t){this.el_history.html(this.tpl_history({list:t,DDate:s}))},calcPos:function(){var t=this.el_friendlist.find("li"),e=t.length,i=t.width(),s=i*e+10;this.el_friendlist.width(s)},onShow:function(){this.calcPos()},onHide:function(){a().endLoopRequest(),h().endLoopRequest()}})});