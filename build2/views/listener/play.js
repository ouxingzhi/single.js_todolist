define("webapp/views/listener/play.js",["webapp/common/baseview","text!webapp/templates/listener/play.html","webapp/models/models","common/lrcview","base/log","webapp/common/app"],function(require){var t=require("webapp/common/baseview"),e=require("text!webapp/templates/listener/play.html"),s=require("webapp/models/models"),a=require("common/lrcview"),i=require("base/log"),n=require("webapp/common/app"),o="header-opacity",r=s.MasterInfoModel.createLazyFun(),l=s.ListenerHeartBeatModel.createLazyFun(),c=s.ListenerLeaveModel.createLazyFun(),h=s.LrcDownloadModel.createLazyFun();return t.extend({onCreate:function(){this.el.html(e),this.el_bgimg=this.$(".js_bgimg"),this.el_name=this.$(".js_name"),this.el_avatar=this.$(".js_avatar"),this.el_songinfo=this.$(".js_songinfo"),this.el_lrcbox=this.$(".js_lrcbox")},events:{"click .topage":"toPage"},toPage:function(){this.forward("friend/list")},userInfo:{},onLoad:function(){var t=this;this.playstatus="none",this.setHeader({title:"我们在听",leftHandle:function(){this.showAlert("退出将无法一起听歌~",[{title:"退出",click:function(){this.hide(),t.back("home")}},{title:"取消",click:function(){this.hide()}}])},hideRightBtn:!0}),this.masterId=this.$Q("masterid"),this.getUid(function(t){this.uploadMasterInfo(this.masterId,t._id),this.loopMasterStatus(this.masterId,t._id)}),this.el_avatar.hide(),this.turning("notanimte")},uploadMasterInfo:function(t,e){this.showLoading();var s=r();s.setParam("masterid",t),s.setParam("listenerId",e),s.setType("GET"),s.request({success:function(t){t&&t.data?(this.userInfo=t.data,this.renderMasterInfo(t.data)):this.showToast("TA已经停止播放了~!",3)},error:function(){this.showToast("TA已经停止播放了~!",3)},complete:function(){this.hideLoading()}},this)},renderMasterInfo:function(t){t.albumPicUrl?this.setBackground("url("+t.albumPicUrl+") no-repeat center center"):this.setBackground("url("+defaultCover+") no-repeat center center","100% 100%!important"),t.albumPicUrl&&this.getRootBg().css({"-webkit-filter":"blur(5px)",filter:"blur(5px)"}),this.el_name.html(t.nickName),this.el_avatar.attr("src",t.picUrl||defaultHand),this.el_avatar.show(),this.el_songinfo.html(t.songName+" - "+t.singerName)},loopMasterStatus:function(t,e){var s=r();s.setParam("masterid",t),s.setParam("listenerId",e);var a=!0;s.loopRequest(2,{success:function(t){this.userInfo=t.data,this.controPlay(t.data,a),a=!1}},this);var i=l();i.setParam("masterid",t),i.setParam("listenerId",e),i.loopRequest(60,{success:function(t){}})},playstatus:"none",checkChnage:function(t){var e=!1,s=[t.songId,t.position,t.action,t.time].join(",");return s!=this.playstatus&&(e=!0),this.playstatus=s,e},controPlay:function(t,e){if(this.checkChnage(t)||e)switch(t.action){case 0:case 1:case 3:case 5:var s=this.lastPlayInfo&&this.lastPlayInfo.songId==t.songId&&this.lastPlayInfo.action==t.action&&this.lastPlayInfo.time==t.time;s?n.resume():n.play({song_id:t.songId,position:t.position}),this.uploadLrc(t.songId),this.renderMasterInfo(t);break;case 2:n.pause();break;case 4:}this.lastPlayInfo=t},lastPlayInfo:null,lrcview:null,uploadLrc:function(t){var e=h(),s=this;e.setParam("id",t),e.request({success:function(t){t=t.replace(/<[^<>]+>/g,""),s.lrcview=new a({wraper:s.el_lrcbox,lrc:t}),s.listenAppPlayStatus()},error:function(){s.lrcview=new a({wraper:s.el_lrcbox,lrc:"[00:00.00]未匹配到歌词，随着节拍哼唱吧~"}),s.endListenAppPlayStatus()}})},listenAppPlayStatus:function(){var t=this;n.listenPlayInfo({callback:function(e){i.log(JSON.stringify(e.position)),t.lrcview.pos(parseInt(e.position/1e3))},error:function(){}},this)},endListenAppPlayStatus:function(){n.unListenPlayInfo({callback:function(){},error:function(){}})},onShow:function(){this.getHeaderRoot().addClass(o)},onHide:function(){this.getHeaderRoot().removeClass(o),n.pause(),r().endLoopRequest(),l().endLoopRequest(),setTimeout(function(){this.endListenAppPlayStatus()}.bind(this),100),this.getUid(function(t){var e=c();e.setParam("masterid",this.masterId),e.setParam("listenerId",t._id),e.setType("DELETE"),e.request()})}})});